import pandas as pd
import os
import requests
from bs4 import BeautifulSoup
from io import StringIO

# URL of trade stats
URL = "https://tradestat.commerce.gov.in/eidb/country_wise_ttrade"

# Path to save CSV
BASE_DIR = os.path.dirname(os.path.abspath(__file__))

def get_trade_data():
    # Fetch HTML page
    response = requests.get(URL)
    response.raise_for_status()

    # Parse HTML using BeautifulSoup
    soup = BeautifulSoup(response.text, "html.parser")
    table = soup.find("table")

    if not table:
        raise ValueError("No tables found on the page")

    # Clean all cell text to remove quotes and extra whitespace
    for cell in table.find_all(["th", "td"]):
        text = cell.get_text(strip=True)
        cell.string = text

    # Convert cleaned table HTML to string and parse with pandas
    table_str = str(table)
    df = pd.read_html(StringIO(table_str))[0]

    # Clean column names
    df.columns = [col.strip() for col in df.columns]

    # (Optional) save CSV locally
    csv_path = os.path.join(BASE_DIR, "data", "trade_stats.csv")
    os.makedirs(os.path.dirname(csv_path), exist_ok=True)
    df.to_csv(csv_path, index=False)

    return df


if __name__ == "__main__":
    df = get_trade_data()
    print(df.head())
